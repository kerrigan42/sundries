### Работа с join'ами, статистикой ###
Установим и запустим PostgreSQL 15:
```
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
sudo pg_ctlcluster 15 main start
```
Создадим таблицы, с которыми будем производить все последующие эксперименты:
```
sudo -u postgres psql
CREATE TABLE bus (id SERIAL, route TEXT, id_model INT, id_driver INT);
CREATE TABLE model_bus (id SERIAL, name TEXT);
INSERT INTO bus VALUES
(1, 'Москва-Болшево', 1, 1),
(2, 'Москва-Пушкино', 1, 2),
(3, 'Москва-Ярославль', 2, 3),
(4, 'Москва-Кострома', 2, 4),
(5, 'Москва-Волгорад', 3, 5),
(6, 'Москва-Иваново', NULL, NULL);
INSERT INTO model_bus VALUES
(1, 'ПАЗ'),
(2, 'ЛИАЗ'),
(3, 'MAN'),
(4, 'МАЗ'),
(5, 'НЕФАЗ');
```
И поехали. 
Реализуем прямое соединение двух таблиц:
```
postgres=# SELECT * FROM bus b JOIN model_bus mb ON b.id_model = mb.id;
 id |      route       | id_model | id_driver | id | name 
----+------------------+----------+-----------+----+------
  1 | Москва-Болшево   |        1 |         1 |  1 | ПАЗ
  2 | Москва-Пушкино   |        1 |         2 |  1 | ПАЗ
  3 | Москва-Ярославль |        2 |         3 |  2 | ЛИАЗ
  4 | Москва-Кострома  |        2 |         4 |  2 | ЛИАЗ
  5 | Москва-Волгорад  |        3 |         5 |  3 | MAN
(5 rows)
```
По совпадающим ключам в двух таблицах возвращены строки, содержащие колонки из обеих таблиц.

Реализовать левостороннее соединение двух таблиц:
```
postgres=# SELECT * FROM bus b LEFT JOIN model_bus mb ON b.id_model = mb.id;
 id |      route       | id_model | id_driver | id | name 
----+------------------+----------+-----------+----+------
  1 | Москва-Болшево   |        1 |         1 |  1 | ПАЗ
  2 | Москва-Пушкино   |        1 |         2 |  1 | ПАЗ
  3 | Москва-Ярославль |        2 |         3 |  2 | ЛИАЗ
  4 | Москва-Кострома  |        2 |         4 |  2 | ЛИАЗ
  5 | Москва-Волгорад  |        3 |         5 |  3 | MAN
  6 | Москва-Иваново   |          |           |    | 
(6 rows)
```
Здесь выведены все строки левой таблицы bus, даже если не найдено строк с тем же ключом в правой таблице. Колонки правой таблицы в таких случаях заполняются null. Например, от прямого соединения результат отличается наличием шестой строки.

Реализуем кросс соединение двух таблиц:
```
postgres=# SELECT * FROM bus b CROSS JOIN model_bus mb;
 id |      route       | id_model | id_driver | id | name  
----+------------------+----------+-----------+----+-------
  1 | Москва-Болшево   |        1 |         1 |  1 | ПАЗ
  2 | Москва-Пушкино   |        1 |         2 |  1 | ПАЗ
  3 | Москва-Ярославль |        2 |         3 |  1 | ПАЗ
  4 | Москва-Кострома  |        2 |         4 |  1 | ПАЗ
  5 | Москва-Волгорад  |        3 |         5 |  1 | ПАЗ
  6 | Москва-Иваново   |          |           |  1 | ПАЗ
  1 | Москва-Болшево   |        1 |         1 |  2 | ЛИАЗ
  2 | Москва-Пушкино   |        1 |         2 |  2 | ЛИАЗ
  3 | Москва-Ярославль |        2 |         3 |  2 | ЛИАЗ
  4 | Москва-Кострома  |        2 |         4 |  2 | ЛИАЗ
  5 | Москва-Волгорад  |        3 |         5 |  2 | ЛИАЗ
  6 | Москва-Иваново   |          |           |  2 | ЛИАЗ
  1 | Москва-Болшево   |        1 |         1 |  3 | MAN
  2 | Москва-Пушкино   |        1 |         2 |  3 | MAN
  3 | Москва-Ярославль |        2 |         3 |  3 | MAN
  4 | Москва-Кострома  |        2 |         4 |  3 | MAN
  5 | Москва-Волгорад  |        3 |         5 |  3 | MAN
  6 | Москва-Иваново   |          |           |  3 | MAN
  1 | Москва-Болшево   |        1 |         1 |  4 | МАЗ
  2 | Москва-Пушкино   |        1 |         2 |  4 | МАЗ
  3 | Москва-Ярославль |        2 |         3 |  4 | МАЗ
  4 | Москва-Кострома  |        2 |         4 |  4 | МАЗ
  5 | Москва-Волгорад  |        3 |         5 |  4 | МАЗ
  6 | Москва-Иваново   |          |           |  4 | МАЗ
  1 | Москва-Болшево   |        1 |         1 |  5 | НЕФАЗ
  2 | Москва-Пушкино   |        1 |         2 |  5 | НЕФАЗ
  3 | Москва-Ярославль |        2 |         3 |  5 | НЕФАЗ
  4 | Москва-Кострома  |        2 |         4 |  5 | НЕФАЗ
  5 | Москва-Волгорад  |        3 |         5 |  5 | НЕФАЗ
  6 | Москва-Иваново   |          |           |  5 | НЕФАЗ
(30 rows)
```
Получилось декартово произведение, где каждая строка из одной таблицы соединяется с каждой строкой из второй таблицы.

Реализуем полное соединение двух таблиц:
```
postgres=# SELECT * FROM bus b FULL JOIN model_bus mb ON b.id_model = mb.id;
 id |      route       | id_model | id_driver | id | name  
----+------------------+----------+-----------+----+-------
  1 | Москва-Болшево   |        1 |         1 |  1 | ПАЗ
  2 | Москва-Пушкино   |        1 |         2 |  1 | ПАЗ
  3 | Москва-Ярославль |        2 |         3 |  2 | ЛИАЗ
  4 | Москва-Кострома  |        2 |         4 |  2 | ЛИАЗ
  5 | Москва-Волгорад  |        3 |         5 |  3 | MAN
  6 | Москва-Иваново   |          |           |    | 
    |                  |          |           |  4 | МАЗ
    |                  |          |           |  5 | НЕФАЗ
(8 rows)
```
Тут выведены строки, у которых совпали ключи. А если ключи не совпали, то строки всё равно выводятся из обеих таблиц, а колонки из противоположной таблицы пусты. 
Например, никто не хочет ездить на моделях автобусов МАЗ и НЕФАЗ, но в выборке они всё равно есть.

Реализуем запрос, в котором будут использованы разные типы соединений:
```
postgres=# SELECT * FROM bus b JOIN model_bus mb ON b.id_model = mb.id LEFT JOIN driver d ON b.id_driver = d.id;
 id |      route       | id_model | id_driver | id | name | id | first_name | second_name 
----+------------------+----------+-----------+----+------+----+------------+-------------
  1 | Москва-Болшево   |        1 |         1 |  1 | ПАЗ  |  1 | Иван       | Иванов
  2 | Москва-Пушкино   |        1 |         2 |  1 | ПАЗ  |  2 | Петр       | Петров
  3 | Москва-Ярославль |        2 |         3 |  2 | ЛИАЗ |  3 | Савелий    | Сидоров
  4 | Москва-Кострома  |        2 |         4 |  2 | ЛИАЗ |  4 | Антон      | Шторкин
  5 | Москва-Волгорад  |        3 |         5 |  3 | MAN  |  5 | Олег       | Зажигаев
(5 rows)
```


